<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ISO 14064 Carbon Footprint Calculator and Reporting platform by AMOC ENERGY M.ABD ELSALAM</title>
<meta name="description" content="ISO 14064 carbon footprint calculator (Scopes 1–3) with emission factor library, M.ABD ELSALAM, and reporting." />
<style>
  :root{
    --bg:#0b1020; --panel:#121a33; --muted:#7d8ab0;
    --pri:#4ea8ff; --pri-2:#8fd3ff; --ok:#38d39f; --warn:#ffcc66; --danger:#ff6b6b;
    --text:#e9f0ff; --text-2:#c8d2ee; --chip:#1a2447; --border:#223055;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0b1020 0%,#0f1530 100%);color:var(--text);font:16px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}

  /* Header not sticky */
  header{position:static;background:rgba(11,16,32,.9);backdrop-filter:saturate(140%) blur(8px);border-bottom:1px solid var(--border)}

  .wrap{max-width:1200px;margin:auto;padding:18px}
  h1{margin:6px 0 0;font-weight:700;font-size:1.35rem}
  .subtitle{margin-top:4px;color:#b7c4ea;font-size:.9rem}
  .brand{display:flex;gap:16px;align-items:center;flex-wrap:wrap}

  /* Cover + client logo */
  .cover-wrap{position:relative}
  .cover-wrap img#cover{
    width:100%;height:auto;object-fit:cover;border-radius:10px;border:1px solid var(--border);
    background:#0d1533;display:block;max-height:300px; /* keeps workspace big */
  }
  #clientLogo{
    position:absolute;right:12px;top:12px;max-width:140px;max-height:90px;display:none;
    background:#fff;border-radius:10px;padding:6px;border:1px solid var(--border)
  }

  .grid{display:grid;gap:16px}
  .grid-2{grid-template-columns:1fr 1fr}
  .grid-3{grid-template-columns:repeat(3,1fr)}
  @media (max-width:900px){.grid-2,.grid-3{grid-template-columns:1fr}}

  section.card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px}
  section.card h2{margin:.2rem 0 8px;font-size:1.1rem}
  label{font-size:.85rem;color:var(--text-2)}
  input,select,textarea,button{
    width:100%;background:#0d1533;border:1px solid var(--border);
    color:var(--text);padding:10px 12px;border-radius:10px;outline:none
  }
  input::placeholder,textarea::placeholder{color:#98a5cc}
  select{appearance:none;background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14"><path fill="%23c8d2ee" d="M2 5l5 5 5-5z"/></svg>');background-repeat:no-repeat;background-position:right 10px center;background-size:14px}
  button{cursor:pointer;background:linear-gradient(180deg, #2a62c7, #1b4da6);border-color:#1a3f8f}
  button.ghost{background:transparent;border-color:var(--border)}
  button.warn{background:linear-gradient(180deg,#f1b74d,#e49a1a);border-color:#d18b18}
  button.danger{background:linear-gradient(180deg,#ff7a7a,#ff5a5a);border-color:#e34a4a}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .row3{display:grid;grid-template-columns:2fr 1fr 1fr;gap:10px}
  .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .chip{padding:6px 10px;background:var(--chip);border:1px solid var(--border);border-radius:999px;font-size:.8rem;color:var(--pri-2)}

  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border-bottom:1px dashed var(--border);padding:10px;text-align:left;vertical-align:middle}
  thead th{position:sticky;top:0;background:#0e1737;z-index:1}
  tbody tr:hover{background:#0f1a3e}
  .right{text-align:right}
  .muted{color:var(--muted)}
  .inline{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

  .totals{display:flex;gap:16px;flex-wrap:wrap}
  .tile{background:#0d1533;border:1px solid var(--border);border-radius:12px;padding:12px 14px;min-width:210px}
  .tile .val{font-weight:700;font-size:1.3rem}
  .sep{height:1px;background:var(--border);margin:10px 0}
  .kpi-s1{border-left:4px solid #5ad1a6}
  .kpi-s2{border-left:4px solid #ffd166}
  .kpi-s3{border-left:4px solid #73c0ff}

  canvas{width:100%;height:240px;background:#0d1533;border:1px solid var(--border);border-radius:10px;display:block}
  .small{font-size:.82rem}
  .factor-row{display:grid;grid-template-columns:1.2fr .8fr .8fr .6fr 1fr 1fr .6fr .6fr .6fr auto;gap:8px}
  .factor-row > *{min-width:0}
  footer{color:#a7b4db}
  .sr-only{position:absolute;left:-10000px;top:auto;width:1px;height:1px;overflow:hidden}
  .no-print{ }
  .print-only{ display:none; }

  /* ===== Print (PDF): clear white & readable ===== */
  @media print {
    *{ color:#000 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    body{ background:#fff !important; }
    header{ position:static !important; background:#fff !important; border:none !important; }
    .wrap{ max-width:100%; padding:0 16px; }
    section.card{ background:#fff !important; border:none; border-radius:0; padding:8px 0 }
/* Hide interactive UI in print, but KEEP factor unit + value visible */
.chips, .subtitle, .no-print, button, input[type=file], input[type=color],
/* hide only buttons inside factor rows, not inputs/selects */
.factor-row button,
/* keep the library rows; hide the add-factor form & activity form */
#factorForm, #itemForm { 
  display: none !important; 
}

    /* Hide interactive UI; keep chart visible */
    .chips, .subtitle, .no-print, button, input[type=file], input[type=color],
    .factor-row button, .factor-row input[aria-label="Value"], .factor-row select,
    #factorForm, #itemForm { display:none !important; }

    /* Hide interactive metadata card in print to avoid duplication */
    section[aria-labelledby="meta-h"] { display:none !important; }

    /* Strong, black table text; EF column emphasized */
    thead th{ position:static; background:#fff !important; }
    th, td{ border-bottom:1px solid #000 !important; color:#000 !important; font-size:11pt; line-height:1.35; }
    td:nth-child(5), th:nth-child(5){ font-weight:700; } /* EF column */
    tbody tr:hover{ background:transparent !important; }

    .print-only { display:block !important; }
    .cover-wrap img#cover{ border:none; }
    #clientLogo{ border:1px solid #000; }
    .tile{ background:#fff; border:1px solid #000 }
    .tile .val{ font-weight:700; }
    th.actions, td.actions{ display:none !important; }
  }

  /* Final override (defeat any cached sticky rule) */
  body > header { position: static !important; top: auto !important; }
/* Emission Factor Library: readable black-on-white fields in print */
#factorList input,
#factorList select {
  background: #fff !important;
  color: #000 !important;
  border: 1px solid #000 !important;
  box-shadow: none !important;
  -webkit-print-color-adjust: exact;
  print-color-adjust: exact;
}

/* Slight emphasis on the factor name; comfortable size/spacing */
#factorList input[aria-label="Name"] { font-weight: 700 !important; }
#factorList .factor-row input,
#factorList .factor-row select {
  padding: 6px 8px !important;
  font-size: 11pt !important;
  line-height: 1.3 !important;
}

</style>
</head>
<body>
<header>
  <div class="wrap" role="banner" aria-label="Site header" style="text-align:center;">
    <!-- Cover + client logo -->
    <div class="cover-wrap">
      <img id="cover" src="amoc-cover.png" alt="AMOC Energy cover">
      <img id="clientLogo" alt="Client logo (uploaded)">
    </div>

    <h1 style="margin-top:0.5rem;">
      ISO 14064 Carbon Footprint Calculator and Reporting platform by AMOC ENERGY
    </h1>
    <div class="subtitle" style="font-size:0.9rem;">
      &lt;By Mohamed Abd Elsalam Seuofy&gt;
    </div>

    <div class="chips" style="margin-top:6px">
      <span class="chip">Scopes 1 · 2 · 3</span>
      <span class="chip">CSV / JSON Import</span>
      <span class="chip">Local Autosave</span>
    </div>

    <!-- Client logo uploader -->
    <div class="inline no-print" style="justify-content:center;margin-top:10px">
      <label for="logoUpload" class="sr-only">Upload client logo</label>
      <input id="logoUpload" type="file" accept="image/*" style="max-width:620px" />
      <button type="button" id="removeLogo" class="ghost">Remove logo</button>
    </div>
  </div>
</header>

<!-- ===== Print-only snapshot so metadata appears as black text ===== -->
<section class="card print-only" id="printMetaBlock" style="margin-top:16px">
  <h2>Organization & Inventory Metadata</h2>
  <table style="width:100%;border-collapse:collapse">
    <tbody>
      <tr><th style="text-align:left;padding:6px 8px;border-bottom:1px solid #000">Organization name</th><td id="p_orgName" style="padding:6px 8px;border-bottom:1px solid #000"></td></tr>
      <tr><th style="text-align:left;padding:6px 8px;border-bottom:1px solid #000">Organization Description</th><td id="p_orgDesc" style="padding:6px 8px;border-bottom:1px solid #000"></td></tr>
      <tr><th style="text-align:left;padding:6px 8px;border-bottom:1px solid #000">Reporting period</th><td id="p_period" style="padding:6px 8px;border-bottom:1px solid #000"></td></tr>
      <tr><th style="text-align:left;padding:6px 8px;border-bottom:1px solid #000">Base year</th><td id="p_baseYear" style="padding:6px 8px;border-bottom:1px solid #000"></td></tr>
      <tr><th style="text-align:left;padding:6px 8px;border-bottom:1px solid #000">Organizational boundary</th><td id="p_boundary" style="padding:6px 8px;border-bottom:1px solid #000"></td></tr>
      <tr><th style="text-align:left;padding:6px 8px;border-bottom:1px solid #000">Verification level</th><td id="p_verification" style="padding:6px 8px;border-bottom:1px solid #000"></td></tr>
      <tr><th style="text-align:left;padding:6px 8px;border-bottom:1px solid #000">Prepared by</th><td id="p_preparedBy" style="padding:6px 8px;border-bottom:1px solid #000"></td></tr>
      <tr><th style="text-align:left;padding:6px 8px;border-bottom:1px solid #000">Inventory notes / boundary exclusions</th><td id="p_notes" style="padding:6px 8px;border-bottom:1px solid #000"></td></tr>
      <tr><th style="text-align:left;padding:6px 8px;border-bottom:1px solid #000">Method notes</th><td id="p_method" style="padding:6px 8px;border-bottom:1px solid #000"></td></tr>
    </tbody>
  </table>
</section>

<main class="wrap" role="main">
  <!-- ORG METADATA (interactive; hidden in print to avoid duplication) -->
  <section class="card" aria-labelledby="meta-h">
    <h2 id="meta-h">Organization & Inventory Metadata</h2>
    <div class="grid grid-3">
      <div>
        <label for="orgName">Organization name</label>
        <input id="orgName" placeholder="Acme Manufacturing Ltd." />
      </div>
      <div>
        <label for="orgDesc">Organization Description</label>
        <input id="orgDesc" placeholder="Brief description of the organization" />
      </div>
      <div>
        <label for="period">Reporting period (YYYY-MM-DD to YYYY-MM-DD)</label>
        <input id="period" placeholder="2024-01-01 to 2024-12-31" />
      </div>
      <div>
        <label for="baseYear">Base year</label>
        <input id="baseYear" type="number" min="1900" max="2100" placeholder="2020" />
      </div>
      <div>
        <label for="boundary">Organizational boundary</label>
        <select id="boundary">
          <option value="equity">Equity share</option>
          <option value="control-financial">Control – Financial</option>
          <option value="control-operational">Control – Operational</option>
        </select>
      </div>
      <div>
        <label for="verification">Verification level</label>
        <select id="verification">
          <option>None</option><option>Limited / Review</option><option>Reasonable Assurance</option>
        </select>
      </div>
      <div>
        <label for="preparedBy">Prepared by</label>
        <input id="preparedBy" placeholder="Name, title" />
      </div>
    </div>
    <div class="sep"></div>
    <div class="grid grid-2">
      <div>
        <label for="notes">Inventory notes / boundary exclusions</label>
        <textarea id="notes" rows="3" placeholder="Describe methods, exclusions, data sources, assumptions…"></textarea>
      </div>
      <div>
        <label for="method">Method notes (market/location-based, refrigerants, etc.)</label>
        <textarea id="method" rows="3" placeholder="e.g., Scope 2 market-based with supplier certificates; Scope 3 categories included…"></textarea>
      </div>
    </div>
  </section>

  <!-- ISO 14064-1 CHECKLIST -->
  <section class="card" aria-labelledby="chk-h">
    <h2 id="chk-h">ISO 14064-1 Checklist</h2>
    <div class="grid grid-2" style="gap:18px">
      <div>
        <h3 class="small" style="margin:0 0 6px">1 — Define Boundaries</h3>
        <label><input type="checkbox" id="c_org_bound"> Organizational boundaries (control or equity share)</label><br>
        <label><input type="checkbox" id="c_rep_bound"> Reporting boundaries (direct & indirect emissions)</label>
      </div>
      <div>
        <h3 class="small" style="margin:0 0 6px">2 — Identify Emissions</h3>
        <label><input type="checkbox" id="c_list_sources"> List all GHG sources and sinks</label><br>
        <label><input type="checkbox" id="c_all_ghg"> Include all relevant GHGs (CO₂, CH₄, N₂O, etc.)</label>
      </div>
      <div>
        <h3 class="small" style="margin:0 0 6px">3 — Quantify Emissions</h3>
        <label><input type="checkbox" id="c_collect_activity"> Collect activity data</label><br>
        <label><input type="checkbox" id="c_apply_ef"> Apply emission factors</label><br>
        <label><input type="checkbox" id="c_convert_co2e"> Convert to CO₂e using latest IPCC GWP</label><br>
        <label><input type="checkbox" id="c_base_year"> Set base year and document it</label>
      </div>
      <div>
        <h3 class="small" style="margin:0 0 6px">3 — Check Indirect Emissions</h3>
        <label><input type="checkbox" id="c_imported_energy"> Imported energy (electricity, steam)</label><br>
        <label><input type="checkbox" id="c_transport"> Transport (business travel, commuting)</label><br>
        <label><input type="checkbox" id="c_products_services"> Products and services (upstream & downstream)</label>
      </div>
      <div>
        <h3 class="small" style="margin:0 0 6px">4 — Manage Quality</h3>
        <label><input type="checkbox" id="c_keep_records"> Keep records and calculations</label><br>
        <label><input type="checkbox" id="c_review_accuracy"> Review data accuracy</label><br>
        <label><input type="checkbox" id="c_assess_uncertainty"> Assess uncertainty</label>
      </div>
      <div>
        <h3 class="small" style="margin:0 0 6px">5 — Report</h3>
        <label><input type="checkbox" id="c_rpt_org_info"> Organization info</label><br>
        <label><input type="checkbox" id="c_rpt_boundaries"> Boundaries</label><br>
        <label><input type="checkbox" id="c_rpt_direct_indirect"> Direct and indirect emissions</label><br>
        <label><input type="checkbox" id="c_rpt_base_year"> Base year</label><br>
        <label><input type="checkbox" id="c_rpt_methods"> Methods used</label><br>
        <label><input type="checkbox" id="c_rpt_uncertainty"> Uncertainty</label><br>
        <label><input type="checkbox" id="c_rpt_verification"> Verification (Optional)</label><br>
        <label><input type="checkbox" id="c_rpt_internal_review"> internal review</label>
      </div>
    </div>
  </section>

  <!-- ADD LINE ITEM -->
  <section class="card" aria-labelledby="add-h">
    <h2 id="add-h">Add Activity Line Item</h2>
    <form id="itemForm" class="grid grid-3" autocomplete="off">
      <div>
        <label for="scope">Scope</label>
        <select id="scope" required>
          <option value="1">Scope 1 – Direct</option>
          <option value="2">Scope 2 – Energy Indirect</option>
          <option value="3">Scope 3 – Other Indirect</option>
        </select>
      </div>
      <div>
        <label for="category">Category</label>
        <input id="category" list="categoryOptions" placeholder="Type or pick…" required />
        <datalist id="categoryOptions">
          <option value="Heating oil (process heat)">
          <option value="Natural gas">
          <option value="Leakage refrigerants">
          <option value="Flare">
          <option value="Diesel vehicles">
          <option value="Gasoline vehicles">
          <option value="Electricity consumption, electricity mix">
          <option value="Purchased media">
          <option value="Purchased goods and services">
          <option value="Paper">
          <option value="Water consumption">
          <option value="Waste">
          <option value="Recycled waste">
          <option value="Non-recycled waste">
        </datalist>
      </div>
      <div class="row">
        <div>
          <label for="activity">Activity amount</label>
          <input id="activity" type="number" step="any" min="0" placeholder="e.g., 12,345" required />
        </div>
        <div>
          <label for="unit">Activity unit</label>
          <select id="unit" required>
            <option>kWh</option><option>MWh</option>
            <option>MMBtu</option>
            <option>litre</option><option>gallon</option>
            <option>kg</option><option>tonne</option>
            <option>km</option><option>mile</option>
            <option>m3</option><option>unit</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div>
          <label for="factorSelect">Emission factor (library)</label>
          <select id="factorSelect"></select>
        </div>
        <div>
          <label for="ef">Or custom EF (kg CO₂e per activity unit)</label>
          <input id="ef" type="number" step="any" min="0" placeholder="e.g., 0.233" />
        </div>
      </div>
      <div class="row3">
        <div>
          <label for="gas">Gas (for documentation)</label>
          <select id="gas">
            <option>CO2e</option><option>CO2</option><option>CH4</option><option>N2O</option><option>Blend/Refrigerant</option><option>Other</option>
          </select>
        </div>
        <div>
          <label for="gwp">GWP100 (if not CO₂e)</label>
          <input id="gwp" type="number" step="any" min="0" placeholder="e.g., 27.2 for CH4" />
        </div>
        <div>
          <label for="year">Data year</label>
          <input id="year" type="number" min="1990" max="2100" placeholder="2024" />
        </div>
      </div>
      <div>
        <label for="source">Data / factor source</label>
        <input id="source" placeholder="Supplier invoice, DEFRA 2024 table, EPA, IPCC…" />
      </div>
      <div>
        <label for="itemNotes">Notes</label>
        <input id="itemNotes" placeholder="Any assumptions or conversions" />
      </div>
      <div class="inline" style="align-items:flex-end">
        <button type="submit" id="addBtn">+ Add line item</button>
        <button type="button" class="ghost" id="resetForm">Clear form</button>
      </div>
    </form>
  </section>

  <!-- LINE ITEMS TABLE -->
  <section class="card" aria-labelledby="tbl-h">
    <h2 id="tbl-h">Activity Lines</h2>
    <div class="small muted">Emissions = Activity × EF (kg CO₂e per unit) × (GWP if gas ≠ CO₂e) → tCO₂e</div>
    <table aria-describedby="tbl-h">
      <thead>
        <tr>
          <th>Scope</th><th>Category</th><th class="right">Activity</th><th>Unit</th>
          <th class="right">EF (kgCO₂e/u)</th><th class="right">Emissions (tCO₂e)</th>
          <th>Year</th><th>Source</th><th>Notes</th><th class="right actions no-print">Actions</th>
        </tr>
      </thead>
      <tbody id="itemsBody"></tbody>
    </table>
    <div class="inline" style="justify-content:flex-end;margin-top:10px;gap:8px">
      <button class="ghost" id="clearAll">Clear all items</button>
      <button id="exportCSV">Export CSV</button>
      <button id="exportJSON">Export JSON</button>
      <button class="warn" id="printReport">Print / PDF</button>
    </div>
  </section>

  <!-- TOTALS + BAR CHART -->
  <section class="card" aria-labelledby="t-h">
    <h2 id="t-h">Totals</h2>
    <div class="totals">
      <div class="tile kpi-s1"><div class="muted">Scope 1</div><div id="tS1" class="val">0.000 tCO₂e</div></div>
      <div class="tile kpi-s2"><div class="muted">Scope 2</div><div id="tS2" class="val">0.000 tCO₂e</div></div>
      <div class="tile kpi-s3"><div class="muted">Scope 3</div><div id="tS3" class="val">0.000 tCO₂e</div></div>
      <div class="tile"><div class="muted">Grand total</div><div id="tAll" class="val">0.000 tCO₂e</div></div>
    </div>
    <div style="margin-top:12px">
      <canvas id="chart" aria-label="Emissions by scope bar chart" role="img"></canvas>
    </div>
  </section>

  <!-- EMISSION FACTOR LIBRARY -->
  <section class="card" aria-labelledby="ef-h">
    <h2 id="ef-h">Emission Factor Library</h2>
    <p class="small">Import JSON or CSV/TSV with columns: <em>Description</em>, <em>Emission factor</em>, <em>Unit</em>, <em>EF-Source</em>, optional <em>Gas</em>, <em>GWP</em>, <em>Year</em>. EFs are in kg CO₂e per unit.</p>
    <div id="factorList" class="grid" style="gap:12px"></div>
    <div class="sep"></div>
    <form id="factorForm" class="factor-row" autocomplete="off" aria-label="Add emission factor">
      <input id="f_name" placeholder="Name (e.g., Grid electricity, country…)" required />
      <select id="f_unit">
        <option>kWh</option><option>MWh</option><option>MMBtu</option>
        <option>litre</option><option>gallon</option><option>kg</option><option>tonne</option>
        <option>km</option><option>mile</option><option>m3</option><option>unit</option>
      </select>
      <input id="f_value" type="number" step="any" min="0" placeholder="EF value (kgCO₂e/u)" required />
      <input id="f_gas" placeholder="Gas / mix" />
      <input id="f_gwp" type="number" step="any" min="0" placeholder="GWP100 basis" />
      <input id="f_source" placeholder="Source" />
      <input id="f_year" type="number" min="1990" max="2100" placeholder="Year" />
      <button type="submit">+ Add Factor</button>
      <button type="button" class="ghost" id="exportFactors">Export Factors</button>
      <label for="importFactors" class="sr-only">Import factors JSON/CSV</label>
      <input type="file" id="importFactors" accept=".json,.csv,.tsv,text/csv,application/json,text/plain" />
    </form>
    <div class="chips"><span class="chip">Units must match your activity</span><span class="chip">EFs in kgCO₂e per unit</span></div>
  </section>

  <footer class="wrap" style="margin: 24px auto">
    <div class="small"><strong>Important:</strong> Replace examples with verified factors; document sources & assumptions. ✔️</div>
  </footer>
</main>

<script>
/* ========= State ========= */
const storageKey = 'cf_iso14064_v1';
const defaultFactors = [
  // Existing examples
  { id: uid(), name:'Electricity – generic grid', unit:'kWh', value:0.233, gas:'CO2e', gwp:'', source:'Example', year:2024 },
  { id: uid(), name:'Natural gas combustion', unit:'kWh', value:0.184, gas:'CO2e', gwp:'', source:'Example', year:2024 },
  { id: uid(), name:'Diesel fuel (stationary/mobile)', unit:'litre', value:2.68, gas:'CO2e', gwp:'', source:'Example', year:2024 },

  // Egypt / requested
  { id: uid(), name:'Electricity – Egypt grid', unit:'kWh', value:0.49, gas:'CO2e', gwp:'', source:'User-provided', year:2024 },
  { id: uid(), name:'Natural Gas (Egypt) – combustion', unit:'MMBtu', value:53.060, gas:'CO2', gwp:'', source:'User-provided', year:2024 },
  { id: uid(), name:'Refrigerant R-22', unit:'kg', value:1960, gas:'Blend/Refrigerant', gwp:'', source:'User-provided', year:2024 },
  { id: uid(), name:'Refrigerant R-134', unit:'kg', value:1530, gas:'Blend/Refrigerant', gwp:'', source:'User-provided', year:2024 },
  { id: uid(), name:'Water (supply/treatment)', unit:'m3', value:0.395, gas:'CO2e', gwp:'', source:'User-provided', year:2024 }
];

let state = {
  meta: {
    orgName:'', orgDesc:'', period:'', baseYear:'', boundary:'equity',
    verification:'None', preparedBy:'', notes:'', method:'',
    logoDataUrl:''
  },
  checklist:{
    c_org_bound:false, c_rep_bound:false, c_list_sources:false, c_all_ghg:false,
    c_collect_activity:false, c_apply_ef:false, c_convert_co2e:false, c_base_year:false,
    c_imported_energy:false, c_transport:false, c_products_services:false,
    c_keep_records:false, c_review_accuracy:false, c_assess_uncertainty:false,
    c_rpt_org_info:false, c_rpt_boundaries:false, c_rpt_direct_indirect:false,
    c_rpt_base_year:false, c_rpt_methods:false, c_rpt_uncertainty:false,
    c_rpt_verification:false, c_rpt_internal_review:false
  },
  items: [],
  factors: defaultFactors
};

/* ========= Utilities ========= */
function uid(){ return Math.random().toString(36).slice(2,9); }
function fmt(n, d=3){ const x = Number(n||0); return x.toLocaleString(undefined,{maximumFractionDigits:d, minimumFractionDigits:d}); }
function toTonnes(kg){ return (Number(kg)||0)/1000; }
function ensureNumber(x){ const n = Number(x); return isFinite(n) ? n : 0; }
function save(){ localStorage.setItem(storageKey, JSON.stringify(state)); }
function load(){
  const raw = localStorage.getItem(storageKey);
  if(raw){ try{ state = { ...state, ...JSON.parse(raw) }; }catch(e){} }
}
function resetAll(){
  if(!confirm('Clear all items and metadata? This cannot be undone.')) return;
  state.items = []; save(); render();
}

/* ========= Metadata ========= */
const metaIds = ['orgName','orgDesc','period','baseYear','boundary','verification','preparedBy','notes','method'];
function bindMeta(){
  metaIds.forEach(id=>{
    const el = document.getElementById(id);
    el.value = state.meta[id] || '';
    el.addEventListener('input', ()=>{ state.meta[id] = el.value; save(); });
  });
}

/* ========= Checklist ========= */
const checkIds = [
  'c_org_bound','c_rep_bound','c_list_sources','c_all_ghg',
  'c_collect_activity','c_apply_ef','c_convert_co2e','c_base_year',
  'c_imported_energy','c_transport','c_products_services',
  'c_keep_records','c_review_accuracy','c_assess_uncertainty',
  'c_rpt_org_info','c_rpt_boundaries','c_rpt_direct_indirect',
  'c_rpt_base_year','c_rpt_methods','c_rpt_uncertainty',
  'c_rpt_verification','c_rpt_internal_review'
];
function bindChecklist(){
  checkIds.forEach(id=>{
    const el = document.getElementById(id);
    el.checked = !!state.checklist[id];
    el.addEventListener('change', ()=>{ state.checklist[id] = el.checked; save(); });
  });
}

/* ========= Client Logo ========= */
function renderLogo(){
  const img = document.getElementById('clientLogo');
  if(state.meta.logoDataUrl){
    img.src = state.meta.logoDataUrl;
    img.style.display = 'block';
  }else{
    img.removeAttribute('src');
    img.style.display = 'none';
  }
}
function setupLogoUpload(){
  const up = document.getElementById('logoUpload');
  up.addEventListener('change', async (e)=>{
    const file = e.target.files && e.target.files[0];
    if(!file) return;
    if(!file.type.startsWith('image/')){ alert('Please choose an image file.'); return; }
    const reader = new FileReader();
    reader.onload = () => {
      state.meta.logoDataUrl = reader.result;
      save(); renderLogo();
    };
    reader.readAsDataURL(file);
    e.target.value = ''; // reset
  });
  document.getElementById('removeLogo').addEventListener('click', ()=>{
    state.meta.logoDataUrl = '';
    save(); renderLogo();
  });
}

/* ========= Factors ========= */
function renderFactors(){
  const list = document.getElementById('factorList');
  list.innerHTML = '';
  if(!state.factors.length){
    const p = document.createElement('p'); p.className='small muted'; p.textContent='No factors yet. Import or add one below.';
    list.appendChild(p); renderFactorSelect(); return;
  }
  state.factors.forEach(f=>{
    const row = document.createElement('div');
    row.className = 'factor-row';
    row.innerHTML = `
      <input aria-label="Name" value="${escapeHTML(f.name)}" />
      <select aria-label="Unit">${unitsOptions(f.unit)}</select>
      <input aria-label="Value" type="number" step="any" min="0" value="${f.value}" />
      <input aria-label="Gas" value="${escapeHTML(f.gas||'')}" />
      <input aria-label="GWP" type="text" value="${escapeHTML(f.gwp||'')}" />
      <input aria-label="Source" value="${escapeHTML(f.source||'')}" />
      <input aria-label="Year" type="number" min="1990" max="2100" value="${escapeHTML(f.year||'')}" />
      <button data-id="${f.id}" class="ghost">Delete</button>
      <button data-id="${f.id}" class="">Save</button>
    `;
    const [nameEl, unitEl, valEl, gasEl, gwpEl, srcEl, yearEl, delBtn, saveBtn] = row.children;
    delBtn.addEventListener('click', ()=>{ 
      if(confirm('Delete factor?')){ state.factors = state.factors.filter(x=>x.id!==f.id); save(); render(); }
    });
    saveBtn.addEventListener('click', ()=>{
      Object.assign(f, {
        name: nameEl.value.trim(),
        unit: unitEl.value,
        value: ensureNumber(valEl.value),
        gas: gasEl.value.trim(),
        gwp: gwpEl.value.trim(),
        source: srcEl.value.trim(),
        year: yearEl.value.trim()
      });
      save(); renderFactorSelect(); toast('Factor saved');
    });
    list.appendChild(row);
  });
  renderFactorSelect();
}
function unitsOptions(sel){
  const units = ['kWh','MWh','MMBtu','litre','gallon','kg','tonne','km','mile','m3','unit'];
  return units.map(u=>`<option ${u===sel?'selected':''}>${u}</option>`).join('');
}
function renderFactorSelect(){
  const sel = document.getElementById('factorSelect');
  sel.innerHTML = `<option value="">— choose a factor —</option>` +
    state.factors.map(f=>`<option value="${f.id}">${escapeHTML(f.name)}  •  ${f.value} kgCO₂e/${f.unit}</option>`).join('');
}
function addFactor(e){
  e.preventDefault();
  const name = getVal('f_name').trim();
  const unit = getVal('f_unit');
  const value = ensureNumber(getVal('f_value'));
  const gas = getVal('f_gas').trim();
  const gwp = getVal('f_gwp').trim();
  const source = getVal('f_source').trim();
  const year = getVal('f_year').trim();
  if(!name || value<0){ return alert('Please provide a valid factor name and value.'); }
  state.factors.push({ id: uid(), name, unit, value, gas, gwp, source, year });
  save(); render(); clearFactorForm();
}
function clearFactorForm(){
  ['f_name','f_value','f_gas','f_gwp','f_source','f_year'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('f_unit').value='kWh';
}

/* === Import: JSON array or {factors:[]} or CSV/TSV with headers === */
async function importFactorsFile(e){
  const file = e.target.files[0];
  if(!file) return;
  const text = await file.text();
  try{
    let parsed;
    if(file.type.includes('json') || text.trim().startsWith('[') || text.trim().startsWith('{')){
      const obj = JSON.parse(text);
      parsed = Array.isArray(obj) ? obj : (Array.isArray(obj.factors) ? obj.factors : null);
      if(!parsed) throw new Error('JSON must be an array of factors or { "factors": [...] }');
      parsed = parsed.map(toFactorShapeFromJSON);
    }else{
      parsed = parseDelimitedToFactors(text); // CSV/TSV
    }
    const cleaned = parsed.map(f => ({
      id: uid(),
      name: String(f.name || '').trim() || 'Unnamed factor',
      unit: String(f.unit || '').trim() || 'unit',
      value: ensureNumber(f.value),
      gas:  (f.gas??'').toString(),
      gwp:  (f.gwp??'').toString(),
      source:(f.source??'').toString(),
      year:  (f.year??'').toString()
    })).filter(f => isFinite(f.value) && f.value >= 0);
    if(!cleaned.length) throw new Error('No valid factors found.');
    state.factors = cleaned; save(); render();
    toast(`Imported ${cleaned.length} factors`);
  }catch(err){
    alert('Import failed: ' + err.message + '\nTip: CSV needs headers: Description, Emission factor, Unit, EF-Source, (Gas, GWP, Year)');
  }finally{ e.target.value = ''; }
}
function toFactorShapeFromJSON(x){
  return {
    name: x.name ?? x.Description ?? x.description,
    unit: x.unit ?? x.Unit,
    value: x.value ?? x['Emission factor'] ?? x.emission_factor,
    gas:  x.gas ?? x.Gas,
    gwp:  x.gwp ?? x.GWP,
    source: x.source ?? x['EF-Source'] ?? x.Source,
    year: x.year ?? x.Year
  };
}
function parseDelimitedToFactors(text){
  const delim = (text.indexOf('\t')>-1) ? '\t' : (text.indexOf(';')>-1 ? ';' : ',');
  const lines = text.split(/\r?\n/).filter(l=>l.trim().length);
  if(lines.length<2) throw new Error('File has no data rows.');
  const header = lines[0].split(delim).map(h=>h.trim().toLowerCase());
  const map = {
    description: ['description','name','factor name','item'],
    value: ['emission factor','ef','value','factor','emission_factor'],
    unit: ['unit','units'],
    source: ['ef-source','source','reference'],
    gas: ['gas'],
    gwp: ['gwp','gwp100'],
    year: ['year','data year','data-year']
  };
  const pos = {};
  for(const key in map){ pos[key] = header.findIndex(h => map[key].includes(h)); }
  if(pos.description<0 || pos.value<0 || pos.unit<0 || pos.source<0){
    throw new Error('Missing required headers. Needed: Description, Emission factor, Unit, EF-Source.');
  }
  const rows = [];
  for(let i=1;i<lines.length;i++){
    const cols = lines[i].split(delim).map(c=>c.trim());
    if(!cols.length || !cols[pos.description]) continue;
    rows.push({
      name: cols[pos.description],
      value: parseFloat((cols[pos.value]||'').replace(',','.')),
      unit: cols[pos.unit],
      source: cols[pos.source],
      gas: pos.gas>=0 ? cols[pos.gas] : '',
      gwp: pos.gwp>=0 ? cols[pos.gwp] : '',
      year: pos.year>=0 ? cols[pos.year] : ''
    });
  }
  return rows;
}
function exportFactors(){ download('emission_factors.json', JSON.stringify(state.factors,null,2)); }

/* ========= Items ========= */
const defaultGWP = { 'CH4': 27.2, 'N2O': 273 }; // handy defaults

function addItem(e){
  e.preventDefault();
  const scope = getVal('scope');
  const category = getVal('category').trim();
  const activity = ensureNumber(getVal('activity'));
  let unit = getVal('unit');
  const factorId = getVal('factorSelect');
  const customEF = getVal('ef').trim();
  const gas = getVal('gas');
  const gwpRaw = getVal('gwp').trim();
  const gwpNum = Number(gwpRaw);
  const year = getVal('year').trim();
  const source = getVal('source').trim();
  const notes = getVal('itemNotes').trim();

  if(!category || activity<=0) return alert('Please provide category and positive activity amount.');

  // Base EF (before GWP) — unchanged calculation
  let efBase = 0, efName = 'Custom';
  if(customEF){
    efBase = ensureNumber(customEF);
  }else if(factorId){
    const f = state.factors.find(x=>x.id===factorId);
    if(!f) return alert('Selected factor not found.');
    unit = f.unit; setVal('unit', f.unit); // sync unit with factor
    efBase = ensureNumber(f.value);
    efName = f.name;
    if(!getVal('gas') && f.gas){ setVal('gas', f.gas); }
    const fGwpNum = Number(f.gwp);
    if(!getVal('gwp') && isFinite(fGwpNum) && fGwpNum>0){ setVal('gwp', String(fGwpNum)); }
  }else{
    return alert('Choose a factor from the library or enter a custom EF.');
  }

  // Apply GWP if needed — unchanged calculation
  const needsGWP = (gas && gas.toUpperCase() !== 'CO2E');
  const multiplier = (needsGWP && isFinite(gwpNum) && gwpNum > 0) ? gwpNum : 1;
  const efEffective = efBase * multiplier;           // kg CO2e per unit
  const emissionsKg = activity * efEffective;        // kg CO2e

  const item = {
    id: uid(), scope, category, activity, unit,
    efBase, ef: efEffective, efName,
    emissionsKg, gas, gwp: gwpRaw, year, source, notes
  };
  state.items.push(item);
  save(); render();
  document.getElementById('itemForm').reset();
  document.getElementById('factorSelect').value='';
}
function deleteItem(id){ state.items = state.items.filter(x=>x.id!==id); save(); render(); }
function editItem(id){
  const it = state.items.find(x=>x.id===id); if(!it) return;
  setVal('scope', it.scope); setVal('category', it.category); setVal('activity', it.activity);
  setVal('unit', it.unit); setVal('ef', it.efBase); setVal('gas', it.gas); setVal('gwp', it.gwp);
  setVal('year', it.year||''); setVal('source', it.source||''); setVal('itemNotes', it.notes||'');
  document.getElementById('factorSelect').value='';
  state.items = state.items.filter(x=>x.id!==it.id); save(); render(); toast('Line loaded into form for editing');
}
function renderItems(){
  const tbody = document.getElementById('itemsBody'); tbody.innerHTML='';
  if(!state.items.length){
    const tr = document.createElement('tr'); const td = document.createElement('td');
    td.colSpan = 10; td.className='muted'; td.textContent='No items yet — add your first line above.';
    tr.appendChild(td); tbody.appendChild(tr); return;
  }
  state.items.forEach(it=>{
    const gwpApplied = (it.gas && it.gas.toUpperCase() !== 'CO2E' && Number(it.gwp) > 0);
    const efLabel = gwpApplied
      ? `${fmt(it.ef,3)} (GWP×${Number(it.gwp).toFixed(2)})`
      : fmt(it.ef,3);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>Scope ${it.scope}</td>
      <td>${escapeHTML(it.category)}</td>
      <td class="right">${fmt(it.activity, 3)}</td>
      <td>${it.unit}</td>
      <td class="right" title="Base EF: ${fmt(it.efBase,3)}; Gas: ${escapeHTML(it.gas||'')}; GWP: ${escapeHTML(it.gwp||'')}">${efLabel}</td>
      <td class="right">${fmt(toTonnes(it.emissionsKg), 3)}</td>
      <td>${escapeHTML(it.year||'')}</td>
      <td>${escapeHTML(it.source||it.efName||'')}</td>
      <td>${escapeHTML(it.notes||'')}</td>
      <td class="right actions no-print">
        <button class="ghost" onclick="editItem('${it.id}')">Edit</button>
        <button class="danger" onclick="deleteItem('${it.id}')">Delete</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

/* ========= Totals + Chart ========= */
function totals(){
  const s1 = state.items.filter(x=>x.scope==='1').reduce((a,b)=>a+b.emissionsKg,0);
  const s2 = state.items.filter(x=>x.scope==='2').reduce((a,b)=>a+b.emissionsKg,0);
  const s3 = state.items.filter(x=>x.scope==='3').reduce((a,b)=>a+b.emissionsKg,0);
  const all = s1+s2+s3;
  setText('tS1', `${fmt(toTonnes(s1))} tCO₂e`);
  setText('tS2', `${fmt(toTonnes(s2))} tCO₂e`);
  setText('tS3', `${fmt(toTonnes(s3))} tCO₂e`);
  setText('tAll', `${fmt(toTonnes(all))} tCO₂e`);
  drawChart([toTonnes(s1), toTonnes(s2), toTonnes(s3)]);
}
function drawChart(vals){
  const c = document.getElementById('chart'); const ctx = c.getContext('2d');
  const w = c.width = c.clientWidth * devicePixelRatio;
  const h = c.height = c.clientHeight * devicePixelRatio;
  ctx.scale(devicePixelRatio, devicePixelRatio);
  ctx.fillStyle = '#0d1533'; ctx.fillRect(0,0,w,h);
  const pad = 28; const areaW = c.clientWidth - pad*2; const areaH = c.clientHeight - pad*2;
  const max = Math.max(1, ...vals) * 1.15;
  ctx.strokeStyle='#223055'; ctx.lineWidth=1;
  for(let i=0;i<=4;i++){
    const y = pad + areaH - (i/4)*areaH;
    ctx.beginPath(); ctx.moveTo(pad,y); ctx.lineTo(pad+areaW,y); ctx.stroke();
    ctx.fillStyle='#7d8ab0'; ctx.font='12px system-ui'; ctx.fillText((max*i/4).toFixed(1), 4, y+4);
  }
  const colors = ['#5ad1a6','#ffd166','#73c0ff']; const labels = ['S1','S2','S3'];
  const barW = areaW/6;
  vals.forEach((v,i)=>{
    const x = pad + barW*(1 + i*2);
    const hBar = (v/max)*areaH;
    const y = pad + areaH - hBar;
    ctx.fillStyle = colors[i]; ctx.fillRect(x, y, barW, hBar);
    ctx.fillStyle = '#c8d2ee'; ctx.font='12px system-ui';
    ctx.fillText(labels[i], x+barW/2-8, pad+areaH+16);
    ctx.fillText(v.toFixed(2)+' t', x+barW/2-18, y-6);
  });
}

/* ========= Export ========= */
function exportCSV(){
  const rows = [
    ['Organization', state.meta.orgName],
    ['OrganizationDescription', state.meta.orgDesc],
    ['Period', state.meta.period],
    ['BaseYear', state.meta.baseYear],
    ['Boundary', state.meta.boundary],
    ['Verification', state.meta.verification],
    ['PreparedBy', state.meta.preparedBy],
    ['Notes', state.meta.notes],
    ['Method', state.meta.method],
    [],
    ['Scope','Category','Activity','Unit','EF (kgCO2e/u)','Emissions (tCO2e)','Year','Source','Notes']
  ];
  state.items.forEach(it=>{
    rows.push([`Scope ${it.scope}`, it.category, it.activity, it.unit, it.ef, toTonnes(it.emissionsKg), it.year||'', it.source||it.efName||'', it.notes||'']);
  });
  const csv = rows.map(r=>r.map(csvCell).join(',')).join('\n');
  download('inventory.csv', csv);
}
function exportJSON(){
  const payload = { meta: state.meta, checklist: state.checklist, items: state.items, totals: getTotalsSnapshot(), factors: state.factors };
  download('inventory.json', JSON.stringify(payload,null,2));
}
function getTotalsSnapshot(){
  const get = s => toTonnes(state.items.filter(x=>x.scope===s).reduce((a,b)=>a+b.emissionsKg,0));
  return { scope1: get('1'), scope2: get('2'), scope3: get('3') };
}

/* ========= Helpers ========= */
function setText(id, txt){ document.getElementById(id).textContent = txt; }
function setVal(id, val){ document.getElementById(id).value = val; }
function getVal(id){ return document.getElementById(id).value; }
function csvCell(x){
  if(x===null||x===undefined) return '';
  const s = String(x);
  if(/[",\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
  return s;
}
function download(filename, content){
  const blob = new Blob([content], {type:'text/plain;charset=utf-8'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename; a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 5000);
}
function escapeHTML(s=''){ return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c])); }
function toast(msg){
  const el = document.createElement('div');
  el.textContent = msg;
  Object.assign(el.style,{position:'fixed',bottom:'18px',left:'50%',transform:'translateX(-50%)',background:'#1a2447',border:'1px solid #223055',padding:'10px 14px',borderRadius:'10px',color:'#e9f0ff',zIndex:9999});
  document.body.appendChild(el);
  setTimeout(()=>el.remove(),1600);
}

/* ========= Factor→form autofill & gas→GWP helper ========= */
function onFactorSelectChange(){
  const id = getVal('factorSelect'); const efInput = document.getElementById('ef');
  if(!id){ efInput.value=''; return; }
  const f = state.factors.find(x=>x.id===id); if(!f) return;
  efInput.value = f.value;            // auto-fill EF
  setVal('unit', f.unit);             // sync unit
  if(f.gas){ setVal('gas', f.gas); }
  const gwpNum = Number(f.gwp); if(isFinite(gwpNum) && gwpNum>0){ setVal('gwp', String(gwpNum)); }
}
function onGasChange(){
  const gas = (getVal('gas')||'').toUpperCase();
  if(defaultGWP[gas] && !getVal('gwp')){
    setVal('gwp', String(defaultGWP[gas]));
  }
}

/* ========= Print snapshot (for clear black-text report) ========= */
function buildPrintSnapshot(){
  const get = id => (document.getElementById(id)?.value || '').toString();
  const set = (id, val) => { const el = document.getElementById(id); if(el) el.textContent = val; };

  set('p_orgName', get('orgName'));
  set('p_orgDesc', get('orgDesc'));
  set('p_period', get('period'));
  set('p_baseYear', get('baseYear'));
  set('p_boundary', document.getElementById('boundary')?.value || '');
  set('p_verification', document.getElementById('verification')?.value || '');
  set('p_preparedBy', get('preparedBy'));
  set('p_notes', get('notes'));
  set('p_method', get('method'));
}

/* ========= Init ========= */
function attachEvents(){
  document.getElementById('itemForm').addEventListener('submit', addItem);
  document.getElementById('resetForm').addEventListener('click', ()=>document.getElementById('itemForm').reset());
  document.getElementById('clearAll').addEventListener('click', resetAll);
  document.getElementById('exportCSV').addEventListener('click', exportCSV);
  document.getElementById('exportJSON').addEventListener('click', exportJSON);
  document.getElementById('printReport').addEventListener('click', ()=>{
    buildPrintSnapshot();
    window.print();
  });

  document.getElementById('factorForm').addEventListener('submit', addFactor);
  document.getElementById('exportFactors').addEventListener('click', exportFactors);
  document.getElementById('importFactors').addEventListener('change', importFactorsFile);

  document.getElementById('factorSelect').addEventListener('change', onFactorSelectChange);
  document.getElementById('gas').addEventListener('change', onGasChange);

  setupLogoUpload();  // logo
}
function render(){ bindMeta(); bindChecklist(); renderLogo(); renderItems(); renderFactors(); totals(); }
(function boot(){ load(); attachEvents(); render(); })();
</script>
</body>
</html>

